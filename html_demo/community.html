<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Community - Fosoler Khoj</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: { 
                    fontFamily: { sans: ['Poppins', 'sans-serif'] },
                    colors: { brand: { dark: '#1A4D2E', light: '#4F772D', accent: '#F9C74F', bg: '#F3F8F2' } } 
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 font-sans">
    
    <header class="bg-white shadow-sm fixed w-full top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex-shrink-0 flex items-center cursor-pointer" onclick="window.location.href='dashboard.html'">
                    <img src="logo.jpeg" onerror="this.src='https://via.placeholder.com/40?text=FK'" class="h-10 w-auto mr-2" alt="Logo">
                    <span class="font-bold text-xl text-brand-dark tracking-tight">Fosoler Khoj</span>
                </div>
                <nav class="hidden md:flex space-x-8">
                    <a href="community.html" class="text-brand-dark font-bold px-3 py-2 text-sm flex items-center border-b-2 border-brand-dark"><i class="fas fa-users mr-2"></i> Community</a>
                    <a href="marketplace.html" class="text-gray-500 hover:text-brand-dark px-3 py-2 text-sm font-medium flex items-center transition"><i class="fas fa-store mr-2"></i> Marketplace</a>
                    <a href="iot.html" class="text-gray-500 hover:text-brand-dark px-3 py-2 text-sm font-medium flex items-center transition"><i class="fas fa-tint mr-2"></i> IoT</a>
                    <a href="ai-detect.html" class="text-gray-500 hover:text-brand-dark px-3 py-2 text-sm font-medium flex items-center transition"><i class="fas fa-microscope mr-2"></i> AI Detect</a>
                </nav>
                <div class="hidden md:flex items-center space-x-4">
                    <a href="index.html" class="text-gray-600 hover:text-red-600 font-medium text-sm transition">Log Out</a>
                    <a href="dashboard.html" class="group flex items-center space-x-2 cursor-pointer bg-brand-bg px-3 py-1.5 rounded-full hover:bg-green-100 transition" title="Go to Profile">
                        <span class="text-xs font-bold text-brand-dark hidden lg:block">My Profile</span>
                        <div id="nav-avatar" class="h-8 w-8 bg-brand-light rounded-full flex items-center justify-center text-white text-xs font-bold shadow-sm group-hover:scale-110 transition-transform">RM</div>
                    </a>
                </div>
            </div>
        </div>
    </header>

    <main class="pt-24 pb-10 min-h-screen">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                
                <div class="lg:col-span-2 space-y-6">
                    <div class="bg-white rounded-2xl shadow-sm p-4 border border-gray-100">
                        <div class="flex space-x-3 mb-4">
                            <div id="post-avatar" class="h-10 w-10 bg-brand-light rounded-full flex items-center justify-center text-white font-bold flex-shrink-0">RM</div>
                            <input type="text" id="postInput" placeholder="Share your farming tips..." class="w-full bg-gray-50 rounded-full px-5 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-brand-light transition">
                        </div>
                        <div id="mediaPreview" class="hidden mb-4 relative w-full h-48 bg-gray-100 rounded-lg overflow-hidden border border-gray-200">
                            <button onclick="clearMedia()" class="absolute top-2 right-2 bg-red-500 text-white rounded-full p-1 w-6 h-6 flex items-center justify-center text-xs z-10 hover:bg-red-600"><i class="fas fa-times"></i></button>
                            <img id="previewImg" class="hidden w-full h-full object-cover">
                            <video id="previewVideo" class="hidden w-full h-full object-cover" controls></video>
                        </div>
                        <div class="flex justify-between items-center border-t pt-3">
                            <div class="flex space-x-4 ml-2">
                                <button onclick="document.getElementById('photoUpload').click()" class="flex items-center space-x-1.5 text-gray-500 hover:text-green-600 transition"><i class="fas fa-image text-green-500"></i> <span class="text-xs font-semibold">Photo</span></button>
                                <input type="file" id="photoUpload" accept="image/*" class="hidden" onchange="handleFileSelect(this, 'image')">
                                <button onclick="document.getElementById('videoUpload').click()" class="flex items-center space-x-1.5 text-gray-500 hover:text-red-600 transition"><i class="fas fa-video text-red-500"></i> <span class="text-xs font-semibold">Video</span></button>
                                <input type="file" id="videoUpload" accept="video/*" class="hidden" onchange="handleFileSelect(this, 'video')">
                            </div>
                            <button onclick="createPost()" class="bg-brand-dark text-white px-6 py-1.5 rounded-full text-sm font-semibold hover:bg-green-800 transition shadow">Post</button>
                        </div>
                    </div>

                    <div id="feed-container" class="space-y-6"></div>
                </div>

                <div class="hidden lg:block lg:col-span-1 space-y-6">
                    <div class="bg-gradient-to-br from-brand-dark to-brand-light rounded-2xl p-6 text-white shadow-lg relative overflow-hidden sticky top-24">
                        <div class="relative z-10">
                            <h3 class="font-bold text-lg opacity-90 border-b border-green-400 pb-2 mb-3">Live Weather</h3>
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-5xl font-bold">28°C</p>
                                    <p class="text-sm font-medium mt-1" id="weather-location">Bogura, BD</p>
                                    <p class="text-xs opacity-80 mt-2 bg-white/20 inline-block px-2 py-1 rounded">Sunny Intervals</p>
                                </div>
                                <div class="text-center">
                                    <i class="fas fa-cloud-sun text-6xl opacity-90 mb-2"></i>
                                    <p class="text-xs">Humidity: 65%</p>
                                </div>
                            </div>
                        </div>
                        <i class="fas fa-leaf absolute -bottom-6 -right-6 text-9xl text-white opacity-10 transform rotate-45"></i>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <script>
        let currentFile = null;
        let currentFileType = null;
        let posts = [];
        let currentUser = { name: "Rahim Mia", initials: "RM", location: "Bogura, BD" };

        function initPage() {
            // Load Profile
            const savedProfile = localStorage.getItem('userProfile');
            if(savedProfile) {
                const data = JSON.parse(savedProfile);
                currentUser.name = data.name;
                currentUser.location = data.location;
                currentUser.initials = data.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
            }
            document.getElementById('nav-avatar').innerText = currentUser.initials;
            document.getElementById('post-avatar').innerText = currentUser.initials;
            document.getElementById('weather-location').innerText = currentUser.location;

            // Load Posts
            const storedPosts = localStorage.getItem('communityPosts');
            if (storedPosts) {
                posts = JSON.parse(storedPosts);
                // Data Migration for old posts (Adding comment arrays if missing)
                posts = posts.map(p => ({
                    ...p, 
                    isLiked: p.isLiked || false,
                    commentsList: p.commentsList || [] // Ensure array exists
                }));
            } else {
                posts = [
                    { id: 1, user: "Karim Uddin", role: "Farmer", initial: "K", color: "blue", time: "2 hrs ago", text: "Finally harvested the new hybrid rice variety.", likes: 24, isLiked: false, commentsList: [{user: "Sufia", text: "Ma sha Allah!"}], mediaType: 'image', mediaSrc: 'https://images.unsplash.com/photo-1500937386664-56d1dfef3854?w=500&auto=format&fit=crop&q=60' },
                    { id: 2, user: "Sufia Begum", role: "Wholesaler", initial: "S", color: "purple", time: "5 hrs ago", text: "Looking for 200kg fresh potatoes.", likes: 12, isLiked: false, commentsList: [], mediaType: null, mediaSrc: null }
                ];
                savePosts();
            }
            renderPosts();
        }

        function savePosts() {
            localStorage.setItem('communityPosts', JSON.stringify(posts));
        }

        function renderPosts() {
            const container = document.getElementById('feed-container');
            container.innerHTML = "";
            
            posts.forEach(post => {
                let mediaHTML = '';
                if (post.mediaType === 'image' && post.mediaSrc) mediaHTML = `<div class="mt-3 rounded-lg overflow-hidden border border-gray-200"><img src="${post.mediaSrc}" class="w-full h-auto object-cover max-h-96"></div>`;
                else if (post.mediaType === 'video' && post.mediaSrc) mediaHTML = `<div class="mt-3 rounded-lg overflow-hidden border border-gray-200"><video src="${post.mediaSrc}" controls class="w-full h-auto max-h-96"></video></div>`;

                // Like Button Style
                const likeIconClass = post.isLiked ? "fas fa-heart text-red-500" : "far fa-heart text-gray-500";
                const likeTextClass = post.isLiked ? "text-red-500" : "text-gray-500";

                // Generate Comments HTML
                let commentsHTML = '';
                if(post.commentsList && post.commentsList.length > 0) {
                    post.commentsList.forEach(c => {
                        commentsHTML += `
                            <div class="flex space-x-2 mt-2 text-sm">
                                <span class="font-bold text-gray-800">${c.user}:</span>
                                <span class="text-gray-600">${c.text}</span>
                            </div>
                        `;
                    });
                }

                container.innerHTML += `
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden animate-fade-in">
                    <div class="p-4 flex justify-between items-start">
                        <div class="flex items-center space-x-3">
                            <div class="h-10 w-10 bg-${post.color || 'green'}-100 rounded-full flex items-center justify-center text-${post.color || 'green'}-600 font-bold text-sm">${post.initial}</div>
                            <div><h3 class="font-bold text-gray-900 text-sm">${post.user}</h3><p class="text-xs text-gray-500">${post.time} • ${post.role}</p></div>
                        </div>
                    </div>
                    
                    <div class="px-4 pb-2">
                        <p class="text-gray-700 text-sm leading-relaxed">${post.text}</p>
                        ${mediaHTML}
                    </div>

                    <div class="px-4 py-3 border-t border-gray-50 flex justify-between items-center mt-2">
                        <button onclick="toggleLike(${post.id})" class="flex items-center space-x-2 ${likeTextClass} hover:text-red-600 transition transform active:scale-90">
                            <i class="${likeIconClass} text-lg"></i> 
                            <span class="text-xs font-medium">${post.likes} Likes</span>
                        </button>
                        
                        <button onclick="toggleCommentBox(${post.id})" class="flex items-center space-x-2 text-gray-500 hover:text-blue-600 transition">
                            <i class="far fa-comment text-lg"></i> 
                            <span class="text-xs font-medium">${post.commentsList ? post.commentsList.length : 0} Comments</span>
                        </button>
                        
                        <button class="text-gray-400 hover:text-brand-dark transition"><i class="fas fa-share-alt"></i></button>
                    </div>

                    <div id="comment-section-${post.id}" class="hidden bg-gray-50 p-4 border-t border-gray-100">
                        <div class="space-y-2 mb-3 max-h-40 overflow-y-auto">
                            ${commentsHTML}
                        </div>
                        
                        <div class="flex items-center space-x-2">
                            <div class="h-8 w-8 bg-brand-light rounded-full flex items-center justify-center text-white text-xs font-bold flex-shrink-0">${currentUser.initials}</div>
                            <input type="text" id="comment-input-${post.id}" placeholder="Write a comment..." class="w-full bg-white border border-gray-300 rounded-full px-4 py-1.5 text-xs focus:outline-none focus:border-brand-dark" onkeypress="handleEnter(event, ${post.id})">
                            <button onclick="addComment(${post.id})" class="text-brand-dark hover:text-green-700 font-bold text-xs">Post</button>
                        </div>
                    </div>
                </div>`;
            });
        }

        // --- INTERACTIVE FUNCTIONS ---

        // 1. Toggle Like
        function toggleLike(id) {
            const post = posts.find(p => p.id === id);
            if(post) {
                if(post.isLiked) {
                    post.likes--;
                    post.isLiked = false;
                } else {
                    post.likes++;
                    post.isLiked = true;
                }
                savePosts();
                renderPosts();
            }
        }

        // 2. Toggle Comment Box Visibility
        function toggleCommentBox(id) {
            const box = document.getElementById(`comment-section-${id}`);
            box.classList.toggle('hidden');
        }

        // 3. Add Comment
        function addComment(id) {
            const input = document.getElementById(`comment-input-${id}`);
            const text = input.value.trim();
            
            if(text !== "") {
                const post = posts.find(p => p.id === id);
                if(post) {
                    if(!post.commentsList) post.commentsList = []; // Init if empty
                    
                    post.commentsList.push({
                        user: currentUser.name,
                        text: text
                    });
                    
                    savePosts();
                    renderPosts();
                    
                    // Re-open comment box after render (since render resets DOM)
                    setTimeout(() => {
                        const box = document.getElementById(`comment-section-${id}`);
                        box.classList.remove('hidden');
                    }, 50);
                }
            }
        }

        // Helper: Submit on Enter Key
        function handleEnter(e, id) {
            if(e.key === 'Enter') addComment(id);
        }

        // --- FILE & POST CREATION (Existing Logic) ---
        function handleFileSelect(input, type) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    currentFile = e.target.result;
                    currentFileType = type;
                    document.getElementById('mediaPreview').classList.remove('hidden');
                    if(type === 'image') {
                        document.getElementById('previewImg').src = currentFile;
                        document.getElementById('previewImg').classList.remove('hidden');
                        document.getElementById('previewVideo').classList.add('hidden');
                    } else {
                        document.getElementById('previewVideo').src = currentFile;
                        document.getElementById('previewVideo').classList.remove('hidden');
                        document.getElementById('previewImg').classList.add('hidden');
                    }
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function clearMedia() {
            currentFile = null; currentFileType = null;
            document.getElementById('mediaPreview').classList.add('hidden');
            document.getElementById('photoUpload').value = ''; 
            document.getElementById('videoUpload').value = '';
        }

        function createPost() {
            const input = document.getElementById('postInput');
            if (input.value.trim() === "" && !currentFile) return;

            const newPost = {
                id: Date.now(),
                user: currentUser.name,
                role: "Farmer",
                initial: currentUser.initials,
                color: "green",
                time: "Just now",
                text: input.value,
                likes: 0,
                isLiked: false,
                commentsList: [],
                mediaType: currentFileType,
                mediaSrc: currentFile
            };

            posts.unshift(newPost);
            savePosts();
            
            input.value = "";
            clearMedia();
            renderPosts();
        }

        initPage();
    </script>
    <style>.animate-fade-in { animation: fadeIn 0.5s ease-out forwards; } @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }</style>
</body>
</html>